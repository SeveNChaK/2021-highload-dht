# Нагрузочное тестирвоание

## Исходный PUT
__Параметры запуска:__
* соединение - 128
* потоков - 1
* длительность - 10мин
* rate - 20000

По результатам замера исходной реализации видно, что при большом количестве соединений старая проблема синхронного flush'а приводит к тому,
что сильное замедление при PUT запросах происходит уже на 50%.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 10m -L -R 20000 -s wrk/put.lua http://localhost:8080
    
    Running 10m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 337.999ms, rate sampling interval: 2893ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   431.66ms  614.90ms   2.50s    79.72%
    Req/Sec    20.01k     7.39k   35.02k    61.08%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    2.73ms
    75.000%  839.68ms
    90.000%    1.50s
    99.000%    1.99s
    99.900%    2.35s
    99.990%    2.47s
    99.999%    2.49s
    100.000%    2.50s

    [Mean    =      431.662, StdDeviation   =      614.899]
    [Max     =     2498.560, Total count    =     11787178]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    11993671 requests in 10.00m, 766.35MB read
    Socket errors: connect 0, read 0, write 0, timeout 384
    Requests/sec:  19989.45
    Transfer/sec:      1.28MB

## Исходный GET
__Параметры запуска:__
* соединение - 128
* потоков - 1
* длительность - 6мин
* rate - 10000

При GET запросах на исходной реализации видно так же большое замедление раньше, нежели, чем при одном соединение. Это происходило
из-за синхронного range'a.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 6m -L -R 10000 -s wrk/get.lua http://localhost:8080
    
    Running 6m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 108.394ms, rate sampling interval: 723ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.79ms    2.63ms 174.59ms   79.36%
    Req/Sec    10.01k    37.08    10.34k    88.20%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    3.48ms
    75.000%    5.22ms
    90.000%    6.60ms
    99.000%    9.22ms
    99.900%   21.30ms
    99.990%   87.04ms
    99.999%  155.13ms
    100.000%  174.72ms

    [Mean    =        3.787, StdDeviation   =        2.628]
    [Max     =      174.592, Total count    =      3493587]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    3589950 requests in 6.00m, 255.70MB read
    Requests/sec:   9972.08
    Transfer/sec:    727.34KB

## Новый PUT
Как видно по результатам запуска wrk2, благодаря flush'у в бэкграунде обработка PUT запроса значительно сократилась: скачок свдинулся с 50% на 99.99%,
а дальнейший рост превратился из секунда в пару десятков миллисекунд.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 10m -L -R 20000 -s wrk/put.lua http://localhost:8080
    
    Running 10m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 1.636ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.65ms  740.32us  14.70ms   67.94%
    Req/Sec    21.08k     2.00k   43.56k    74.41%

    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.52ms
    75.000%    2.12ms
    90.000%    2.68ms
    99.000%    3.53ms
    99.900%    5.22ms
    99.990%    8.83ms
    99.999%   11.38ms
    100.000%   14.71ms

    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)

       0.155     0.000000            1         1.00
       0.796     0.100000      1180781         1.11
       0.999     0.200000      2360055         1.25
       1.170     0.300000      3536185         1.43
       1.338     0.400000      4715419         1.67
       1.519     0.500000      5897822         2.00
       1.618     0.550000      6488651         2.22
       1.725     0.600000      7075248         2.50
       1.843     0.650000      7663531         2.86
       1.976     0.700000      8254947         3.33
       2.125     0.750000      8847347         4.00
       2.203     0.775000      9139397         4.44
       2.285     0.800000      9433708         5.00
       2.371     0.825000      9724599         5.71
       2.467     0.850000     10023901         6.67
       2.569     0.875000     10317075         8.00
       2.623     0.887500     10461282         8.89
       2.683     0.900000     10611425        10.00
       2.745     0.912500     10755921        11.43
       2.815     0.925000     10903557        13.33
       2.895     0.937500     11053229        16.00
       2.939     0.943750     11127173        17.78
       2.985     0.950000     11198621        20.00
       3.037     0.956250     11271794        22.86
       3.097     0.962500     11347378        26.67
       3.163     0.968750     11419677        32.00
       3.201     0.971875     11457078        35.56
       3.241     0.975000     11492984        40.00
       3.287     0.978125     11530585        45.71
       3.337     0.981250     11567112        53.33
       3.393     0.984375     11603209        64.00
       3.427     0.985938     11622433        71.11
       3.461     0.987500     11640529        80.00
       3.499     0.989062     11658643        91.43
       3.543     0.990625     11676950       106.67
       3.593     0.992188     11695225       128.00
       3.623     0.992969     11704647       142.22
       3.655     0.993750     11713764       160.00
       3.693     0.994531     11723168       182.86
       3.737     0.995313     11732210       213.33
       3.793     0.996094     11741418       256.00
       3.829     0.996484     11745926       284.44
       3.873     0.996875     11750474       320.00
       3.931     0.997266     11755016       365.71
       4.015     0.997656     11759669       426.67
       4.163     0.998047     11764227       512.00
       4.295     0.998242     11766521       568.89
       4.475     0.998437     11768807       640.00
       4.699     0.998633     11771109       731.43
       4.959     0.998828     11773419       853.33
       5.267     0.999023     11775711      1024.00
       5.455     0.999121     11776854      1137.78
       5.667     0.999219     11778020      1280.00
       5.895     0.999316     11779146      1462.86
       6.159     0.999414     11780311      1706.67
       6.467     0.999512     11781459      2048.00
       6.659     0.999561     11782030      2275.56
       6.855     0.999609     11782599      2560.00
       7.071     0.999658     11783184      2925.71
       7.319     0.999707     11783750      3413.33
       7.591     0.999756     11784329      4096.00
       7.755     0.999780     11784618      4551.11
       7.935     0.999805     11784903      5120.00
       8.127     0.999829     11785192      5851.43
       8.335     0.999854     11785479      6826.67
       8.575     0.999878     11785770      8192.00
       8.711     0.999890     11785914      9102.22
       8.847     0.999902     11786057     10240.00
       9.031     0.999915     11786198     11702.86
       9.247     0.999927     11786342     13653.33
       9.479     0.999939     11786489     16384.00
       9.607     0.999945     11786564     18204.44
       9.711     0.999951     11786633     20480.00
       9.815     0.999957     11786702     23405.71
       9.959     0.999963     11786773     27306.67
      10.151     0.999969     11786844     32768.00
      10.271     0.999973     11786881     36408.89
      10.391     0.999976     11786917     40960.00
      10.527     0.999979     11786954     46811.43
      10.679     0.999982     11786988     54613.33
      10.911     0.999985     11787025     65536.00
      11.007     0.999986     11787043     72817.78
      11.143     0.999988     11787060     81920.00
      11.279     0.999989     11787078     93622.86
      11.479     0.999991     11787096    109226.67
      11.687     0.999992     11787114    131072.00
      11.823     0.999993     11787123    145635.56
      11.959     0.999994     11787132    163840.00
      12.159     0.999995     11787141    187245.71
      12.335     0.999995     11787150    218453.33
      12.575     0.999996     11787160    262144.00
      12.623     0.999997     11787163    291271.11
      12.847     0.999997     11787168    327680.00
      12.951     0.999997     11787172    374491.43
      13.167     0.999998     11787178    436906.67
      13.239     0.999998     11787181    524288.00
      13.391     0.999998     11787183    582542.22
      13.623     0.999998     11787186    655360.00
      13.711     0.999999     11787188    748982.86
      13.815     0.999999     11787190    873813.33
      13.831     0.999999     11787192   1048576.00
      13.847     0.999999     11787193   1165084.44
      13.879     0.999999     11787195   1310720.00
      13.935     0.999999     11787197   1497965.71
      13.935     0.999999     11787197   1747626.67
      14.087     1.000000     11787198   2097152.00
      14.087     1.000000     11787198   2330168.89
      14.295     1.000000     11787199   2621440.00
      14.495     1.000000     11787201   2995931.43
      14.495     1.000000     11787201   3495253.33
      14.495     1.000000     11787201   4194304.00
      14.495     1.000000     11787201   4660337.78
      14.495     1.000000     11787201   5242880.00
      14.687     1.000000     11787202   5991862.86
      14.687     1.000000     11787202   6990506.67
      14.687     1.000000     11787202   8388608.00
      14.687     1.000000     11787202   9320675.55
      14.687     1.000000     11787202  10485760.00
      14.711     1.000000     11787203  11983725.71
      14.711     1.000000     11787203          inf
    [Mean    =        1.647, StdDeviation   =        0.740]
    [Max     =       14.704, Total count    =     11787203]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    11993683 requests in 10.00m, 766.35MB read
    Requests/sec:  19989.48
    Transfer/sec:      1.28MB

__Профилирование PUT:__  
[PUT cpu](./put_cpu.html)  
По графику профилирования видно, что flush теперь уехал в отдельный поток, и время put запроса
entity значительно сократилось. Так же как и в первом этапе много времени занимает чтение и запись в сокет, и работа селекторов.
Еще видно небольшой кусочек GC, который с первого этапа слегка подрос. Можно попробовать с ним что-то сделать...наверное, 
пока не знаю как.
[PUT lock](./put_lock.html)  
Количество блокировок значительно снизилось до 135, которые, видимо, успели проскачить в "окно" между проверками в функции flush.
Это говорит о хорошей эффективности такого подхода. Однако хотелось бы добиться еще лучших резлуьтатов, чтоб вообще не было 
или буквально несколько единиц. Но пока нет идей, как улучшить. 
[PUT alloc](./put_alloc.html)  

## Новый GET
Чет сломалось...

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 1m -L -R 20000 -s wrk/get.lua http://localhost:8080
    
    Running 1m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 5039.023ms, rate sampling interval: 18333ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    33.85s    14.02s    0.99m    59.80%
    Req/Sec    58.00      1.00    59.00    100.00%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%   33.21s
    75.000%   45.32s
    90.000%    0.90m
    99.000%    0.98m
    99.900%    0.99m
    99.990%    0.99m
    99.999%    0.99m
    100.000%    0.99m

    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)
    
    10239.999     0.000000            1         1.00
    14770.175     0.100000          274         1.11
    19562.495     0.200000          550         1.25
    24150.015     0.300000          822         1.43
    28770.303     0.400000         1097         1.67
    33210.367     0.500000         1368         2.00
    35487.743     0.550000         1505         2.22
    38174.719     0.600000         1644         2.50
    40501.247     0.650000         1780         2.86
    42893.311     0.700000         1916         3.33
    45318.143     0.750000         2052         4.00
    46563.327     0.775000         2122         4.44
    47742.975     0.800000         2192         5.00
    49151.999     0.825000         2259         5.71
    51445.759     0.850000         2327         6.67
    52887.551     0.875000         2397         8.00
    53542.911     0.887500         2429         8.89
    54263.807     0.900000         2463        10.00
    54919.167     0.912500         2497        11.43
    55541.759     0.925000         2532        13.33
    56197.119     0.937500         2566        16.00
    56557.567     0.943750         2584        17.78
    57016.319     0.950000         2602        20.00
    57311.231     0.956250         2619        22.86
    57638.911     0.962500         2634        26.67
    57835.519     0.968750         2653        32.00
    58097.663     0.971875         2661        35.56
    58228.735     0.975000         2668        40.00
    58392.575     0.978125         2679        45.71
    58458.111     0.981250         2685        53.33
    58753.023     0.984375         2696        64.00
    58785.791     0.985938         2698        71.11
    58982.399     0.987500         2702        80.00
    59047.935     0.989062         2709        91.43
    59080.703     0.990625         2711       106.67
    59146.239     0.992188         2716       128.00
    59179.007     0.992969         2720       142.22
    59179.007     0.993750         2720       160.00
    59244.543     0.994531         2723       182.86
    59277.311     0.995313         2724       213.33
    59375.615     0.996094         2727       256.00
    59375.615     0.996484         2727       284.44
    59473.919     0.996875         2728       320.00
    59506.687     0.997266         2729       365.71
    59539.455     0.997656         2731       426.67
    59539.455     0.998047         2731       512.00
    59572.223     0.998242         2734       568.89
    59572.223     0.998437         2734       640.00
    59572.223     0.998633         2734       731.43
    59572.223     0.998828         2734       853.33
    59572.223     0.999023         2734      1024.00
    59572.223     0.999121         2734      1137.78
    59572.223     0.999219         2734      1280.00
    59604.991     0.999316         2736      1462.86
    59604.991     1.000000         2736          inf
    [Mean    =    33851.027, StdDeviation   =    14020.400]
    [Max     =    59572.224, Total count    =         2736]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    3399 requests in 1.00m, 234.59KB read
    Socket errors: connect 0, read 0, write 0, timeout 686
    Requests/sec:     56.58
    Transfer/sec:      3.90KB

__Профилирование GET:__  
[GET cpu](./get_cpu.html)
Как будто в пустую базу хожу...хотя put делал перед get. Может дело и в путе. Памагите
[GET lock](./get_lock.html)