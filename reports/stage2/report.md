# Нагрузочное тестирвоание

## Исходный PUT
__Параметры запуска:__
* соединение - 128
* потоков - 1
* длительность - 10мин
* rate - 20000

По результатам замера исходной реализации видно, что при большом количестве соединений старая проблема синхронного flush'а приводит к тому,
что сильное замедление при PUT запросах происходит уже на 50%.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 10m -L -R 20000 -s wrk/put.lua http://localhost:8080
    
    Running 10m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 337.999ms, rate sampling interval: 2893ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   431.66ms  614.90ms   2.50s    79.72%
    Req/Sec    20.01k     7.39k   35.02k    61.08%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    2.73ms
    75.000%  839.68ms
    90.000%    1.50s
    99.000%    1.99s
    99.900%    2.35s
    99.990%    2.47s
    99.999%    2.49s
    100.000%    2.50s

    [Mean    =      431.662, StdDeviation   =      614.899]
    [Max     =     2498.560, Total count    =     11787178]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    11993671 requests in 10.00m, 766.35MB read
    Socket errors: connect 0, read 0, write 0, timeout 384
    Requests/sec:  19989.45
    Transfer/sec:      1.28MB

## Исходный GET
__Параметры запуска:__
* соединение - 128
* потоков - 1
* длительность - 6мин
* rate - 10000

При GET запросах на исходной реализации видно так же большое замедление раньше, нежели, чем при одном соединение. Это происходило
из-за синхронного range'a.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 6m -L -R 10000 -s wrk/get.lua http://localhost:8080
    
    Running 6m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 108.394ms, rate sampling interval: 723ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.79ms    2.63ms 174.59ms   79.36%
    Req/Sec    10.01k    37.08    10.34k    88.20%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    3.48ms
    75.000%    5.22ms
    90.000%    6.60ms
    99.000%    9.22ms
    99.900%   21.30ms
    99.990%   87.04ms
    99.999%  155.13ms
    100.000%  174.72ms

    [Mean    =        3.787, StdDeviation   =        2.628]
    [Max     =      174.592, Total count    =      3493587]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    3589950 requests in 6.00m, 255.70MB read
    Requests/sec:   9972.08
    Transfer/sec:    727.34KB

## Новый PUT
Как видно по результатам запуска wrk2, благодаря flush'у в бэкграунде обработка PUT запроса значительно сократилась: скачок свдинулся с 50% на 99.9%,
а дальнейший рост превратился из секунда в пару десятков миллисекунд.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 10m -L -R 20000 -s wrk/put.lua http://localhost:8080
    
    Running 10m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 1.640ms, rate sampling interval: 10ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.67ms  767.76us  21.98ms   69.44%
    Req/Sec    21.08k     2.05k   39.22k    72.72%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.53ms
    75.000%    2.14ms
    90.000%    2.70ms
    99.000%    3.61ms
    99.900%    5.76ms
    99.990%   12.19ms
    99.999%   18.82ms
    100.000%   22.00ms

    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)

       0.131     0.000000            1         1.00
       0.804     0.100000      1183327         1.11
       1.008     0.200000      2360734         1.25
       1.182     0.300000      3536896         1.43
       1.352     0.400000      4720982         1.67
       1.534     0.500000      5894580         2.00
       1.635     0.550000      6486743         2.22
       1.745     0.600000      7077404         2.50
       1.864     0.650000      7663349         2.86
       1.997     0.700000      8253313         3.33
       2.145     0.750000      8846278         4.00
       2.223     0.775000      9139785         4.44
       2.305     0.800000      9433503         5.00
       2.393     0.825000      9729737         5.71
       2.487     0.850000     10023209         6.67
       2.589     0.875000     10316547         8.00
       2.645     0.887500     10464964         8.89
       2.703     0.900000     10608973        10.00
       2.769     0.912500     10759803        11.43
       2.839     0.925000     10904644        13.33
       2.921     0.937500     11053763        16.00
       2.965     0.943750     11125266        17.78
       3.015     0.950000     11200144        20.00
       3.069     0.956250     11272748        22.86
       3.131     0.962500     11345891        26.67
       3.203     0.968750     11419937        32.00
       3.243     0.971875     11456371        35.56
       3.287     0.975000     11493222        40.00
       3.337     0.978125     11530706        45.71
       3.391     0.981250     11566732        53.33
       3.455     0.984375     11603944        64.00
       3.491     0.985938     11621860        71.11
       3.531     0.987500     11640070        80.00
       3.577     0.989062     11658846        91.43
       3.629     0.990625     11677261       106.67
       3.693     0.992188     11695582       128.00
       3.731     0.992969     11704512       142.22
       3.777     0.993750     11713595       160.00
       3.833     0.994531     11722770       182.86
       3.907     0.995313     11731967       213.33
       4.013     0.996094     11741171       256.00
       4.087     0.996484     11745764       284.44
       4.187     0.996875     11750392       320.00
       4.323     0.997266     11755031       365.71
       4.495     0.997656     11759632       426.67
       4.715     0.998047     11764167       512.00
       4.859     0.998242     11766486       568.89
       5.035     0.998437     11768814       640.00
       5.243     0.998633     11771073       731.43
       5.495     0.998828     11773391       853.33
       5.787     0.999023     11775677      1024.00
       5.979     0.999121     11776840      1137.78
       6.199     0.999219     11777997      1280.00
       6.439     0.999316     11779127      1462.86
       6.711     0.999414     11780283      1706.67
       7.087     0.999512     11781444      2048.00
       7.295     0.999561     11782012      2275.56
       7.547     0.999609     11782585      2560.00
       7.871     0.999658     11783160      2925.71
       8.311     0.999707     11783734      3413.33
       8.911     0.999756     11784313      4096.00
       9.223     0.999780     11784601      4551.11
       9.599     0.999805     11784883      5120.00
      10.087     0.999829     11785173      5851.43
      10.639     0.999854     11785462      6826.67
      11.391     0.999878     11785747      8192.00
      11.799     0.999890     11785893      9102.22
      12.279     0.999902     11786033     10240.00
      12.775     0.999915     11786179     11702.86
      13.559     0.999927     11786321     13653.33
      14.327     0.999939     11786466     16384.00
      14.687     0.999945     11786537     18204.44
      15.167     0.999951     11786612     20480.00
      15.575     0.999957     11786682     23405.71
      16.079     0.999963     11786755     27306.67
      16.479     0.999969     11786826     32768.00
      16.735     0.999973     11786862     36408.89
      17.039     0.999976     11786897     40960.00
      17.391     0.999979     11786935     46811.43
      17.663     0.999982     11786969     54613.33
      18.015     0.999985     11787006     65536.00
      18.175     0.999986     11787024     72817.78
      18.479     0.999988     11787043     81920.00
      18.703     0.999989     11787060     93622.86
      18.991     0.999991     11787077    109226.67
      19.407     0.999992     11787095    131072.00
      19.551     0.999993     11787104    145635.56
      19.679     0.999994     11787113    163840.00
      19.919     0.999995     11787124    187245.71
      20.111     0.999995     11787131    218453.33
      20.303     0.999996     11787140    262144.00
      20.383     0.999997     11787144    291271.11
      20.463     0.999997     11787149    327680.00
      20.607     0.999997     11787153    374491.43
      20.751     0.999998     11787158    436906.67
      20.863     0.999998     11787162    524288.00
      20.943     0.999998     11787164    582542.22
      21.071     0.999998     11787167    655360.00
      21.119     0.999999     11787169    748982.86
      21.231     0.999999     11787173    873813.33
      21.231     0.999999     11787173   1048576.00
      21.263     0.999999     11787174   1165084.44
      21.375     0.999999     11787176   1310720.00
      21.487     0.999999     11787177   1497965.71
      21.503     0.999999     11787178   1747626.67
      21.519     1.000000     11787179   2097152.00
      21.519     1.000000     11787179   2330168.89
      21.615     1.000000     11787180   2621440.00
      21.679     1.000000     11787181   2995931.43
      21.679     1.000000     11787181   3495253.33
      21.743     1.000000     11787182   4194304.00
      21.743     1.000000     11787182   4660337.78
      21.743     1.000000     11787182   5242880.00
      21.759     1.000000     11787183   5991862.86
      21.759     1.000000     11787183   6990506.67
      21.759     1.000000     11787183   8388608.00
      21.759     1.000000     11787183   9320675.55
      21.759     1.000000     11787183  10485760.00
      21.999     1.000000     11787184  11983725.71
      21.999     1.000000     11787184          inf
    [Mean    =        1.666, StdDeviation   =        0.768]
    [Max     =       21.984, Total count    =     11787184]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    11993687 requests in 10.00m, 766.35MB read
    Requests/sec:  19989.48
    Transfer/sec:      1.28MB

__Профилирование PUT:__  
[PUT cpu](./put_cpu.html)  
По графику профилирования видно, что flush теперь уехал в отдельный поток, и время put запроса
entity значительно сократилось. Так же как и в первом этапе много времени занимает чтение и запись в сокет, и работа селекторов.  
[PUT lock](./put_lock.html)  
Количество блокировок из тысяч превратилось в единицы, которая успели проскачить в "окно" между проверками в функции flush.
Это говорит о хорошей эффективности такого подхода.  
[PUT alloc](./put_alloc.html)  

## Новый GET
Отказ от блока synchronized в методе range, что перестало блокировать запросы, позволил свдинуть скачок с 99% на 99.99%, а пиковое значение ответа понизить с
сотен до 18ms.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 10m -L -R 20000 -s wrk/get.lua http://localhost:8080
    
    Running 10m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 1.683ms, rate sampling interval: 10ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.73ms  766.06us  18.29ms   65.80%
    Req/Sec    21.10k     1.88k   33.10k    73.02%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.58ms
    75.000%    2.27ms
    90.000%    2.83ms
    99.000%    3.64ms
    99.900%    4.26ms
    99.990%    6.17ms
    99.999%   12.96ms
    100.000%   18.30ms

    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)

       0.232     0.000000            1         1.00
       0.833     0.100000      1183344         1.11
       1.038     0.200000      2360106         1.25
       1.217     0.300000      3540058         1.43
       1.390     0.400000      4716755         1.67
       1.578     0.500000      5898083         2.00
       1.686     0.550000      6487624         2.22
       1.811     0.600000      7073571         2.50
       1.958     0.650000      7663328         2.86
       2.115     0.700000      8257695         3.33
       2.271     0.750000      8847672         4.00
       2.349     0.775000      9137211         4.44
       2.433     0.800000      9436277         5.00
       2.519     0.825000      9724969         5.71
       2.613     0.850000     10020571         6.67
       2.715     0.875000     10317813         8.00
       2.769     0.887500     10465462         8.89
       2.825     0.900000     10609566        10.00
       2.887     0.912500     10757455        11.43
       2.955     0.925000     10903243        13.33
       3.033     0.937500     11050724        16.00
       3.077     0.943750     11125675        17.78
       3.125     0.950000     11200190        20.00
       3.177     0.956250     11272024        22.86
       3.239     0.962500     11345566        26.67
       3.313     0.968750     11419942        32.00
       3.353     0.971875     11456450        35.56
       3.395     0.975000     11493398        40.00
       3.439     0.978125     11530704        45.71
       3.483     0.981250     11566718        53.33
       3.533     0.984375     11603951        64.00
       3.559     0.985938     11621893        71.11
       3.587     0.987500     11640123        80.00
       3.619     0.989062     11659084        91.43
       3.653     0.990625     11676856       106.67
       3.693     0.992188     11695228       128.00
       3.717     0.992969     11704942       142.22
       3.741     0.993750     11713690       160.00
       3.771     0.994531     11723050       182.86
       3.805     0.995313     11732052       213.33
       3.849     0.996094     11741484       256.00
       3.875     0.996484     11746034       284.44
       3.905     0.996875     11750482       320.00
       3.941     0.997266     11755122       365.71
       3.985     0.997656     11759758       426.67
       4.037     0.998047     11764298       512.00
       4.067     0.998242     11766517       568.89
       4.103     0.998437     11768840       640.00
       4.147     0.998633     11771111       731.43
       4.203     0.998828     11773521       853.33
       4.267     0.999023     11775746      1024.00
       4.307     0.999121     11776863      1137.78
       4.355     0.999219     11778013      1280.00
       4.415     0.999316     11779161      1462.86
       4.491     0.999414     11780331      1706.67
       4.591     0.999512     11781461      2048.00
       4.663     0.999561     11782058      2275.56
       4.747     0.999609     11782620      2560.00
       4.847     0.999658     11783192      2925.71
       4.995     0.999707     11783764      3413.33
       5.179     0.999756     11784343      4096.00
       5.291     0.999780     11784634      4551.11
       5.411     0.999805     11784914      5120.00
       5.559     0.999829     11785201      5851.43
       5.747     0.999854     11785495      6826.67
       5.951     0.999878     11785784      8192.00
       6.067     0.999890     11785921      9102.22
       6.199     0.999902     11786064     10240.00
       6.375     0.999915     11786210     11702.86
       6.603     0.999927     11786352     13653.33
       6.867     0.999939     11786497     16384.00
       7.019     0.999945     11786568     18204.44
       7.219     0.999951     11786640     20480.00
       7.423     0.999957     11786714     23405.71
       7.783     0.999963     11786784     27306.67
       8.503     0.999969     11786857     32768.00
       8.831     0.999973     11786892     36408.89
       9.391     0.999976     11786928     40960.00
       9.983     0.999979     11786964     46811.43
      10.759     0.999982     11787000     54613.33
      11.471     0.999985     11787037     65536.00
      12.071     0.999986     11787054     72817.78
      12.415     0.999988     11787074     81920.00
      12.823     0.999989     11787090     93622.86
      13.167     0.999991     11787108    109226.67
      13.591     0.999992     11787126    131072.00
      13.847     0.999993     11787135    145635.56
      14.127     0.999994     11787144    163840.00
      14.391     0.999995     11787154    187245.71
      14.743     0.999995     11787162    218453.33
      15.143     0.999996     11787171    262144.00
      15.231     0.999997     11787175    291271.11
      15.431     0.999997     11787180    327680.00
      15.735     0.999997     11787184    374491.43
      15.863     0.999998     11787189    436906.67
      16.111     0.999998     11787193    524288.00
      16.183     0.999998     11787195    582542.22
      16.359     0.999998     11787198    655360.00
      16.447     0.999999     11787201    748982.86
      16.655     0.999999     11787202    873813.33
      16.831     0.999999     11787204   1048576.00
      16.927     0.999999     11787205   1165084.44
      17.023     0.999999     11787207   1310720.00
      17.071     0.999999     11787208   1497965.71
      17.119     0.999999     11787209   1747626.67
      17.231     1.000000     11787210   2097152.00
      17.231     1.000000     11787210   2330168.89
      17.279     1.000000     11787212   2621440.00
      17.279     1.000000     11787212   2995931.43
      17.279     1.000000     11787212   3495253.33
      17.311     1.000000     11787213   4194304.00
      17.311     1.000000     11787213   4660337.78
      17.311     1.000000     11787213   5242880.00
      18.047     1.000000     11787214   5991862.86
      18.047     1.000000     11787214   6990506.67
      18.047     1.000000     11787214   8388608.00
      18.047     1.000000     11787214   9320675.55
      18.047     1.000000     11787214  10485760.00
      18.303     1.000000     11787215  11983725.71
      18.303     1.000000     11787215          inf
    [Mean    =        1.728, StdDeviation   =        0.766]
    [Max     =       18.288, Total count    =     11787215]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    11993720 requests in 10.00m, 858.69MB read
    Non-2xx or 3xx responses: 56
    Requests/sec:  19989.45
    Transfer/sec:      1.43MB

__Профилирование GET:__  
[GET cpu](./get_cpu.html)  
В GET запросах чтение, запись и селекторы тоже занимают не малое время процеесора, однако метод range занимает больше всего - 
67%. Вероятно, это связано с тем, что все запросы обращаются к этому методу и сервер все время висит там, поэтмоу профайлер видит
только такой стек.
[GET lock](./get_lock.html)  
Все локи пропали благодаря убранному synchronized в методе range.
[GET alloc](./get_alloc.html)  