# Нагрузочное тестирвоание

Параметры запуска:
* соединение - 1
* потоков - 1
* длительность - 10мин
* rate - 1000

## PUT-запрос

    wrk2 -c 1 -t 1 -d 10m -L -R 1000 -s wrk/put.lua http://localhost:8080
    Running 10m test @ http://localhost:8080
    1 threads and 1 connections
    Thread calibration: mean lat.: 1.131ms, rate sampling interval: 10ms
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.09ms  117.11ms   1.99s    98.90%
    Req/Sec     1.06k   526.84    27.44k    98.89%
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.18ms
    75.000%    1.54ms
    90.000%    1.85ms
    99.000%  276.73ms
    99.900%    1.78s
    99.990%    1.96s
    99.999%    1.99s
    100.000%    2.00s
    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)

       0.059     0.000000            1         1.00
       0.552     0.100000        59096         1.11
       0.752     0.200000       118166         1.25
       0.902     0.300000       177283         1.43
       1.041     0.400000       236133         1.67
       1.179     0.500000       295006         2.00
       1.248     0.550000       324573         2.22
       1.317     0.600000       354328         2.50
       1.386     0.650000       383691         2.86
       1.459     0.700000       413338         3.33
       1.539     0.750000       442681         4.00
       1.580     0.775000       457318         4.44
       1.624     0.800000       472096         5.00
       1.670     0.825000       486863         5.71
       1.719     0.850000       501720         6.67
       1.775     0.875000       516302         8.00
       1.810     0.887500       523713         8.89
       1.850     0.900000       531093        10.00
       1.891     0.912500       538386        11.43
       1.939     0.925000       545847        13.33
       1.997     0.937500       553222        16.00
       2.028     0.943750       556924        17.78
       2.061     0.950000       560685        20.00
       2.095     0.956250       564284        22.86
       2.137     0.962500       568019        26.67
       2.205     0.968750       571570        32.00
       2.255     0.971875       573434        35.56
       2.313     0.975000       575261        40.00
       2.371     0.978125       577100        45.71
       2.443     0.981250       578969        53.33
       2.537     0.984375       580794        64.00
       2.595     0.985938       581719        71.11
       2.719     0.987500       582622        80.00
     144.255     0.989062       583544        91.43
     364.543     0.990625       584465       106.67
     584.703     0.992188       585387       128.00
     694.783     0.992969       585849       142.22
     804.351     0.993750       586309       160.00
     940.031     0.994531       586770       182.86
    1087.487     0.995313       587231       213.33
    1234.943     0.996094       587693       256.00
    1308.671     0.996484       587925       284.44
    1381.375     0.996875       588153       320.00
    1454.079     0.997266       588383       365.71
    1527.807     0.997656       588615       426.67
    1600.511     0.998047       588845       512.00
    1637.375     0.998242       588962       568.89
    1673.215     0.998437       589075       640.00
    1710.079     0.998633       589192       731.43
    1745.919     0.998828       589306       853.33
    1781.759     0.999023       589420      1024.00
    1800.191     0.999121       589479      1137.78
    1818.623     0.999219       589537      1280.00
    1836.031     0.999316       589593      1462.86
    1854.463     0.999414       589652      1706.67
    1872.895     0.999512       589711      2048.00
    1881.087     0.999561       589737      2275.56
    1890.303     0.999609       589766      2560.00
    1899.519     0.999658       589796      2925.71
    1907.711     0.999707       589824      3413.33
    1917.951     0.999756       589852      4096.00
    1926.143     0.999780       589869      4551.11
    1932.287     0.999805       589882      5120.00
    1938.431     0.999829       589896      5851.43
    1945.599     0.999854       589910      6826.67
    1951.743     0.999878       589924      8192.00
    1955.839     0.999890       589932      9102.22
    1958.911     0.999902       589940     10240.00
    1961.983     0.999915       589946     11702.86
    1965.055     0.999927       589953     13653.33
    1968.127     0.999939       589960     16384.00
    1970.175     0.999945       589965     18204.44
    1972.223     0.999951       589969     20480.00
    1974.271     0.999957       589971     23405.71
    1977.343     0.999963       589975     27306.67
    1980.415     0.999969       589978     32768.00
    1982.463     0.999973       589980     36408.89
    1984.511     0.999976       589983     40960.00
    1985.535     0.999979       589984     46811.43
    1987.583     0.999982       589986     54613.33
    1988.607     0.999985       589987     65536.00
    1989.631     0.999986       589989     72817.78
    1989.631     0.999988       589989     81920.00
    1990.655     0.999989       589990     93622.86
    1991.679     0.999991       589991    109226.67
    1992.703     0.999992       589992    131072.00
    1992.703     0.999993       589992    145635.56
    1993.727     0.999994       589993    163840.00
    1993.727     0.999995       589993    187245.71
    1994.751     0.999995       589995    218453.33
    1994.751     0.999996       589995    262144.00
    1994.751     0.999997       589995    291271.11
    1994.751     0.999997       589995    327680.00
    1994.751     0.999997       589995    374491.43
    1994.751     0.999998       589995    436906.67
    1994.751     0.999998       589995    524288.00
    1994.751     0.999998       589995    582542.22
    1995.775     0.999998       589996    655360.00
    1995.775     1.000000       589996          inf
    [Mean    =       12.093, StdDeviation   =      117.109]
    [Max     =     1994.752, Total count    =       589996]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    600000 requests in 10.00m, 38.34MB read
    Requests/sec:   1000.00
    Transfer/sec:     65.43KB

Видно, что 90% запросов обрабатывается в среднем менее чем за 2мс, а дальше время, причиной этого, скорее всего, является
начало записи данных из памяти на диск.  
__Результаты профилирования:__  
[PUT cpu](./put_cpu.html)  
По результатам профилирования видно, что треть процессорного времени занимает метод handleRequest, из которых 60% уходит
на отправку ответа, а оставшееся время на запись данных. Значительную часть метода upsert занимает flush в физическую память.
А так же не малое количество времени уходит на сравнение элементов при вставке в MemTable.  
Поэтому стоит обратить внимание на два этих местах. Из возможных способов в голову приходит распараллеливание.  
[PUT alloc](./put_alloc.html)  
По памяти схожая ситуация по процентному распределению затраченных ресурсов.

## GET-запрос

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 1 -t 1 -d 10m -L -R 1000 -s wrk/get.lua http://localhost:8080
    Running 10m test @ http://localhost:8080
    1 threads and 1 connections
    Thread calibration: mean lat.: 1.153ms, rate sampling interval: 10ms
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.18ms    0.86ms  94.91ms   93.95%
    Req/Sec     1.04k    88.16    11.67k    88.56%
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.17ms
    75.000%    1.51ms
    90.000%    1.75ms
    99.000%    2.33ms
    99.900%    2.67ms
    99.990%   41.57ms
    99.999%   89.79ms
    100.000%   94.97ms
    
    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)

       0.075     0.000000            1         1.00
       0.589     0.100000        59099         1.11
       0.758     0.200000       118234         1.25
       0.899     0.300000       177108         1.43
       1.034     0.400000       236175         1.67
       1.166     0.500000       295288         2.00
       1.233     0.550000       324611         2.22
       1.300     0.600000       354023         2.50
       1.369     0.650000       383653         2.86
       1.438     0.700000       413202         3.33
       1.510     0.750000       442611         4.00
       1.547     0.775000       457283         4.44
       1.586     0.800000       472288         5.00
       1.625     0.825000       486821         5.71
       1.665     0.850000       501538         6.67
       1.706     0.875000       516319         8.00
       1.727     0.887500       523659         8.89
       1.750     0.900000       531280        10.00
       1.774     0.912500       538459        11.43
       1.806     0.925000       545768        13.33
       1.856     0.937500       553213        16.00
       1.889     0.943750       556829        17.78
       1.928     0.950000       560530        20.00
       1.968     0.956250       564225        22.86
       2.013     0.962500       567905        26.67
       2.061     0.968750       571560        32.00
       2.085     0.971875       573424        35.56
       2.111     0.975000       575250        40.00
       2.139     0.978125       577185        45.71
       2.167     0.981250       578951        53.33
       2.207     0.984375       580786        64.00
       2.235     0.985938       581742        71.11
       2.265     0.987500       582664        80.00
       2.303     0.989062       583587        91.43
       2.345     0.990625       584489       106.67
       2.391     0.992188       585391       128.00
       2.413     0.992969       585851       142.22
       2.437     0.993750       586324       160.00
       2.465     0.994531       586779       182.86
       2.495     0.995313       587249       213.33
       2.529     0.996094       587700       256.00
       2.545     0.996484       587928       284.44
       2.563     0.996875       588162       320.00
       2.581     0.997266       588393       365.71
       2.601     0.997656       588636       426.67
       2.621     0.998047       588858       512.00
       2.629     0.998242       588957       568.89
       2.639     0.998437       589079       640.00
       2.651     0.998633       589199       731.43
       2.665     0.998828       589321       853.33
       2.677     0.999023       589431      1024.00
       2.685     0.999121       589489      1137.78
       2.693     0.999219       589538      1280.00
       2.703     0.999316       589592      1462.86
       2.721     0.999414       589651      1706.67
       2.743     0.999512       589709      2048.00
       2.759     0.999561       589740      2275.56
       2.785     0.999609       589768      2560.00
       2.807     0.999658       589795      2925.71
       2.843     0.999707       589824      3413.33
       2.873     0.999756       589850      4096.00
       2.909     0.999780       589865      4551.11
       2.953     0.999805       589879      5120.00
       3.825     0.999829       589894      5851.43
      16.639     0.999854       589908      6826.67
      29.551     0.999878       589922      8192.00
      36.959     0.999890       589930      9102.22
      43.423     0.999902       589937     10240.00
      49.823     0.999915       589944     11702.86
      56.255     0.999927       589951     13653.33
      62.591     0.999939       589958     16384.00
      66.239     0.999945       589962     18204.44
      69.887     0.999951       589966     20480.00
      72.511     0.999957       589969     23405.71
      76.159     0.999963       589973     27306.67
      78.911     0.999969       589976     32768.00
      80.703     0.999973       589978     36408.89
      82.495     0.999976       589980     40960.00
      84.351     0.999979       589982     46811.43
      86.143     0.999982       589984     54613.33
      87.103     0.999985       589985     65536.00
      87.999     0.999986       589986     72817.78
      88.895     0.999988       589987     81920.00
      89.791     0.999989       589988     93622.86
      90.687     0.999991       589989    109226.67
      91.583     0.999992       589990    131072.00
      91.583     0.999993       589990    145635.56
      92.415     0.999994       589991    163840.00
      92.415     0.999995       589991    187245.71
      93.311     0.999995       589992    218453.33
      93.311     0.999996       589992    262144.00
      93.311     0.999997       589992    291271.11
      94.143     0.999997       589993    327680.00
      94.143     0.999997       589993    374491.43
      94.143     0.999998       589993    436906.67
      94.143     0.999998       589993    524288.00
      94.143     0.999998       589993    582542.22
      94.975     0.999998       589994    655360.00
      94.975     1.000000       589994          inf
    [Mean    =        1.185, StdDeviation   =        0.858]
    [Max     =       94.912, Total count    =       589994]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    599999 requests in 10.00m, 42.23MB read
    Requests/sec:   1000.00
    Transfer/sec:     72.07KB

В полученных результатах видно, что 99.9% запросов обрабатывается менее чем за 3мс, а дальше идет увеличение времени ответа,
что, скорее всего, связано с отсутствие данных в оперативной памяти и приходится обращатсья к физической.  
__Результаты профилирования:__  
[GET cpu](./get_cpu.html)  
60% всего времени уходит на handleRequest, из которых 40% уходит на обработку метода getEntity. Где большая часть тратится
на обращение к SSTable, а именно метод range. А также заметно времени уходит на проход по элементам.
Из оптимизаций на ум ничего не приходит, но смотреть стоит в сторону работы с SSTable.  
[GET alloc](./get_alloc.html)  
Аналогичная ситуация с CPU.