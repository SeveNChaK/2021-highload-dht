### PUT-запросы
Шаги из этапа №2 (асинхронный flush и compact) и асинхронный сервер очень хорошо сказались на put'ах. Небольшой скачок теперь
оказлся на 99.9%, а максимальное время ответа достигло порядка 7мс.  
Замедление, как мне кажется, моежт быть связано с асинхронным сервером и заполеннием очереди обработки запросов.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 3m -L -R 10000 -s wrk/put.lua http://localhost:8080
    
    Running 3m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 1.100ms, rate sampling interval: 10ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.93ms  316.04us   7.97ms   62.01%
    Req/Sec     2.89k     0.87k    4.40k    61.10%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    0.93ms
    75.000%    1.18ms
    90.000%    1.33ms
    99.000%    1.50ms
    99.900%    1.72ms
    99.990%    5.45ms
    99.999%    7.47ms
    100.000%    7.97ms

    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)

       0.170     0.000000            1         1.00
       0.499     0.100000        46593         1.11
       0.617     0.200000        92893         1.25
       0.737     0.300000       139272         1.43
       0.835     0.400000       185585         1.67
       0.934     0.500000       231940         2.00
       0.982     0.550000       255042         2.22
       1.030     0.600000       278216         2.50
       1.080     0.650000       301285         2.86
       1.132     0.700000       324227         3.33
       1.182     0.750000       347316         4.00
       1.206     0.775000       358870         4.44
       1.230     0.800000       370575         5.00
       1.255     0.825000       382423         5.71
       1.280     0.850000       393756         6.67
       1.307     0.875000       405511         8.00
       1.320     0.887500       411085         8.89
       1.334     0.900000       417001        10.00
       1.348     0.912500       422679        11.43
       1.363     0.925000       428687        13.33
       1.378     0.937500       434270        16.00
       1.387     0.943750       437207        17.78
       1.396     0.950000       439955        20.00
       1.406     0.956250       442894        22.86
       1.417     0.962500       445869        26.67
       1.429     0.968750       448690        32.00
       1.436     0.971875       450141        35.56
       1.443     0.975000       451439        40.00
       1.452     0.978125       452960        45.71
       1.462     0.981250       454406        53.33
       1.474     0.984375       455804        64.00
       1.481     0.985938       456560        71.11
       1.488     0.987500       457220        80.00
       1.497     0.989062       457970        91.43
       1.508     0.990625       458728       106.67
       1.520     0.992188       459397       128.00
       1.528     0.992969       459782       142.22
       1.537     0.993750       460143       160.00
       1.546     0.994531       460484       182.86
       1.558     0.995313       460838       213.33
       1.572     0.996094       461207       256.00
       1.581     0.996484       461394       284.44
       1.591     0.996875       461567       320.00
       1.604     0.997266       461745       365.71
       1.618     0.997656       461929       426.67
       1.634     0.998047       462102       512.00
       1.644     0.998242       462192       568.89
       1.657     0.998437       462285       640.00
       1.671     0.998633       462373       731.43
       1.695     0.998828       462463       853.33
       1.725     0.999023       462554      1024.00
       1.743     0.999121       462600      1137.78
       1.765     0.999219       462644      1280.00
       1.797     0.999316       462689      1462.86
       1.839     0.999414       462735      1706.67
       1.935     0.999512       462779      2048.00
       2.039     0.999561       462802      2275.56
       2.255     0.999609       462826      2560.00
       2.593     0.999658       462847      2925.71
       2.957     0.999707       462871      3413.33
       3.435     0.999756       462892      4096.00
       3.797     0.999780       462904      4551.11
       3.991     0.999805       462915      5120.00
       4.323     0.999829       462927      5851.43
       4.699     0.999854       462938      6826.67
       5.083     0.999878       462949      8192.00
       5.355     0.999890       462955      9102.22
       5.451     0.999902       462960     10240.00
       5.623     0.999915       462966     11702.86
       5.899     0.999927       462972     13653.33
       6.195     0.999939       462977     16384.00
       6.351     0.999945       462980     18204.44
       6.563     0.999951       462983     20480.00
       6.695     0.999957       462986     23405.71
       6.807     0.999963       462989     27306.67
       6.951     0.999969       462991     32768.00
       7.007     0.999973       462993     36408.89
       7.047     0.999976       462994     40960.00
       7.107     0.999979       462996     46811.43
       7.243     0.999982       462997     54613.33
       7.291     0.999985       462998     65536.00
       7.335     0.999986       462999     72817.78
       7.467     0.999988       463000     81920.00
       7.483     0.999989       463001     93622.86
       7.483     0.999991       463001    109226.67
       7.579     0.999992       463002    131072.00
       7.579     0.999993       463002    145635.56
       7.767     0.999994       463004    163840.00
       7.767     0.999995       463004    187245.71
       7.767     0.999995       463004    218453.33
       7.767     0.999996       463004    262144.00
       7.767     0.999997       463004    291271.11
       7.767     0.999997       463004    327680.00
       7.767     0.999997       463004    374491.43
       7.767     0.999998       463004    436906.67
       7.975     0.999998       463005    524288.00
       7.975     1.000000       463005          inf
    [Mean    =        0.928, StdDeviation   =        0.316]
    [Max     =        7.972, Total count    =       463005]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    492390 requests in 3.00m, 31.46MB read
    Socket errors: connect 0, read 0, write 0, timeout 8165
    Requests/sec:   2735.50
    Transfer/sec:    178.98KB
__Результаты профилирования:__  
[PUT cpu](./stage3_put_cpu.html)  
Видно, что сборщик мусора стал поджирать больше. Также время начало уходить на запуск потоков. 26% времени съедает обращение
к очереди executor service'а, возможно с ней можно как-то пошаманить, так как она еще и локов много пораждает. Ну и все так же 
прилично времени уходит на взаимодействие с сетью. Вроде в дальнейших этапах должны будем менять протокол, чтоб решить эту проблему.

[PUT lock](./stage3_put_lock.html)  
Много локов на очереди executor'а, наверное, с этим можно что-то сделать, но пока не знаю как. Получается очень быстро приходят задачи на выполнение,
а испоняются дольше.

[PUT alloc](./stage3_put_alloc.html)  


### GET-запросы
Метод GET теперь тоже молод и горяч как PUT, но чуток меньше. Небольшйо скачок так же есть на 99.9%, а максимальное время
ответа порядка 11мс.  
Так же как и с PUT'ами замедление может быть связано с очередью обработки.

    alexey.korneev@WH0132099 2021-highload-dht % wrk2 -c 128 -t 1 -d 3m -L -R 10000 -s wrk/get.lua http://localhost:8080
    
    Running 3m test @ http://localhost:8080
    1 threads and 128 connections
    Thread calibration: mean lat.: 1.206ms, rate sampling interval: 10ms
    
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.09ms  378.25us  11.18ms   71.13%
    Req/Sec     1.93k     0.97k    3.89k    64.64%
    
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.09ms
    75.000%    1.33ms
    90.000%    1.50ms
    99.000%    2.13ms
    99.900%    3.12ms
    99.990%    8.33ms
    99.999%   11.10ms
    100.000%   11.18ms

    Detailed Percentile spectrum:
    Value   Percentile   TotalCount 1/(1-Percentile)

       0.254     0.000000            2         1.00
       0.605     0.100000        31084         1.11
       0.759     0.200000        61921         1.25
       0.888     0.300000        93015         1.43
       0.986     0.400000       123850         1.67
       1.085     0.500000       154998         2.00
       1.133     0.550000       170229         2.22
       1.181     0.600000       185795         2.50
       1.230     0.650000       201386         2.86
       1.277     0.700000       216647         3.33
       1.325     0.750000       232264         4.00
       1.350     0.775000       240146         4.44
       1.375     0.800000       247759         5.00
       1.402     0.825000       255333         5.71
       1.432     0.850000       263229         6.67
       1.465     0.875000       270860         8.00
       1.484     0.887500       274778         8.89
       1.504     0.900000       278521        10.00
       1.527     0.912500       282442        11.43
       1.554     0.925000       286297        13.33
       1.587     0.937500       290176        16.00
       1.607     0.943750       292124        17.78
       1.629     0.950000       293987        20.00
       1.655     0.956250       295923        22.86
       1.688     0.962500       297897        26.67
       1.727     0.968750       299820        32.00
       1.754     0.971875       300774        35.56
       1.785     0.975000       301742        40.00
       1.822     0.978125       302702        45.71
       1.874     0.981250       303661        53.33
       1.940     0.984375       304630        64.00
       1.979     0.985938       305109        71.11
       2.028     0.987500       305597        80.00
       2.085     0.989062       306086        91.43
       2.157     0.990625       306563       106.67
       2.247     0.992188       307053       128.00
       2.299     0.992969       307288       142.22
       2.357     0.993750       307529       160.00
       2.417     0.994531       307770       182.86
       2.479     0.995313       308015       213.33
       2.557     0.996094       308256       256.00
       2.611     0.996484       308374       284.44
       2.665     0.996875       308493       320.00
       2.727     0.997266       308615       365.71
       2.793     0.997656       308736       426.67
       2.871     0.998047       308856       512.00
       2.915     0.998242       308918       568.89
       2.961     0.998437       308978       640.00
       3.007     0.998633       309041       731.43
       3.065     0.998828       309102       853.33
       3.127     0.999023       309159      1024.00
       3.175     0.999121       309189      1137.78
       3.229     0.999219       309220      1280.00
       3.291     0.999316       309249      1462.86
       3.361     0.999414       309281      1706.67
       3.423     0.999512       309310      2048.00
       3.475     0.999561       309325      2275.56
       3.543     0.999609       309340      2560.00
       3.647     0.999658       309356      2925.71
       3.723     0.999707       309370      3413.33
       3.847     0.999756       309385      4096.00
       3.959     0.999780       309393      4551.11
       4.039     0.999805       309400      5120.00
       4.379     0.999829       309408      5851.43
       4.503     0.999854       309415      6826.67
       7.635     0.999878       309423      8192.00
       8.231     0.999890       309427      9102.22
       8.335     0.999902       309430     10240.00
       8.471     0.999915       309434     11702.86
       8.671     0.999927       309439     13653.33
       8.903     0.999939       309442     16384.00
       9.855     0.999945       309444     18204.44
      10.151     0.999951       309445     20480.00
      10.439     0.999957       309447     23405.71
      10.655     0.999963       309449     27306.67
      10.751     0.999969       309451     32768.00
      10.999     0.999973       309453     36408.89
      10.999     0.999976       309453     40960.00
      11.047     0.999979       309454     46811.43
      11.087     0.999982       309455     54613.33
      11.103     0.999985       309457     65536.00
      11.103     0.999986       309457     72817.78
      11.103     0.999988       309457     81920.00
      11.103     0.999989       309457     93622.86
      11.151     0.999991       309459    109226.67
      11.151     0.999992       309459    131072.00
      11.151     0.999993       309459    145635.56
      11.151     0.999994       309459    163840.00
      11.151     0.999995       309459    187245.71
      11.151     0.999995       309459    218453.33
      11.151     0.999996       309459    262144.00
      11.151     0.999997       309459    291271.11
      11.183     0.999997       309460    327680.00
      11.183     1.000000       309460          inf
    [Mean    =        1.087, StdDeviation   =        0.378]
    [Max     =       11.176, Total count    =       309460]
    [Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    334310 requests in 3.00m, 23.48MB read
    Socket errors: connect 0, read 0, write 0, timeout 9156
    Non-2xx or 3xx responses: 27
    Requests/sec:   1857.28
    Transfer/sec:    133.57KB
__Результаты профилирования:__  
[GET cpu](./stage3_get_cpu.html)  
Тут так же видно значительно расходование времени на работу с очередью и взаимодействия с сетью. Еще видно, что селекторы
частенько находятся в вызове lockAndDoSelect, что бы это ни значило. Наверное, стоит что-то сделать с очередью...

[GET lock](./stage3_get_lock.html)    
Много локов на очереди executor'а, наверное, с этим можно что-то сделать, но пока не знаю как. Получается очень быстро приходят задачи на выполнение,
а испоняются дольше.

[GET alloc](./stage3_get_alloc.html)  